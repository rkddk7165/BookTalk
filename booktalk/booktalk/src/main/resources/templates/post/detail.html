<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title th:text="${post.title} ?: '글 상세'">글 상세</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        :root{
            --bg:#121212; --ink:#f5f5f5; --muted:#bdbdbd; --line:#2b2b2b; --card:#1b1b1b;
            --primary:#3b82f6; --danger:#ef4444; --ok:#22c55e; --chip:#2a2a2a; --chip-border:#3a3a3a;
            --badge:#2f2f2f; --badge-border:#4b4b4b; --notice-bg:#3b2f13; --notice-ink:#ffecb5; --best-bg:#c7d2fe; --best-ink:#312e81;
        }
        *{box-sizing:border-box}
        body{background:var(--bg); color:var(--ink); font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
        a{color:#cbd5ff; text-decoration:none}
        a:hover{text-decoration:underline}

        .page{max-width:1000px; margin:28px auto; padding:0 16px;}
        .head{display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;}
        .title{font-size:22px; font-weight:800; color:#fff; line-height:1.35; word-break:keep-all}
        .badges{display:flex; gap:8px; margin-top:10px;}
        .badge{display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--badge-border); background:var(--badge); color:#e5e7eb;}
        .badge.notice{background:var(--notice-bg); color:var(--notice-ink); border-color:#8a6d1f;}
        .badge.best{background:var(--best-bg); color:var(--best-ink); border-color:#a5b4fc;}

        .meta{display:flex; gap:12px; color:var(--muted); font-size:12px;}
        .meta .kv{display:flex; gap:6px; align-items:center;}
        .divider{opacity:.45}

        .content-wrap{background:var(--card); border:1px solid var(--line); border-radius:10px; overflow:hidden;}
        .content{padding:20px; white-space:pre-wrap; line-height:1.8; font-size:16px; min-height:180px;}

        /* 추천/비추 박스 */
        .vote-wrap{display:flex; justify-content:center; margin:28px 0;}
        .vote{width:300px; border:1px solid var(--line); background:var(--card); border-radius:8px; padding:16px; display:flex; justify-content:space-around; align-items:center;}
        .vote .box{display:flex; flex-direction:column; align-items:center; gap:8px;}
        .vote .count{font-size:20px; font-weight:800;}
        .vote .btn{width:72px; height:72px; border-radius:50%; border:1px solid var(--chip-border); background:var(--chip); color:#fff; cursor:pointer;}
        .vote .btn.up{border-color:#224da7; background:#1f2b44;}
        .vote .btn.down{border-color:#7a2a2a; background:#3a2323;}
        .vote .label{font-size:12px; color:var(--muted);}

        .sub-actions{display:flex; gap:12px; justify-content:center; margin-top:10px; color:var(--muted); font-size:12px;}
        .tool-row{display:flex; justify-content:flex-end; gap:8px; margin:10px 0 18px;}


        /* 버튼 충돌 방지 → page 컨테이너 하위로 한정 */
        .page .btn{padding:8px 12px; border-radius:8px; border:1px solid var(--chip-border); background:var(--chip); color:#fff; text-decoration:none; cursor:pointer;}
        .page .btn.primary{background:var(--primary); border-color:var(--primary);}
        .page .btn.danger{background:#7f1d1d; border-color:#7f1d1d;}
        .page .btn.ghost{background:transparent; border-color:var(--chip-border);}
        .page .btn.xs{padding:6px 10px; font-size:12px; border-radius:8px;}

        /* 하단 정보/뉴스 박스 (자리 채움용) */
        .news{margin:26px 0 10px; border:1px solid var(--line); background:var(--card); border-radius:8px; padding:14px;}
        .news-title{font-weight:700; margin-bottom:10px; color:#eaeaea; font-size:14px;}
        .news ul{margin:0; padding-left:18px; color:var(--muted); font-size:13px;}
        .news li{margin:6px 0;}

        /* 댓글 (리뉴얼) */
        .cmt-wrap{margin-top:16px; border:1px solid var(--line); background:var(--card); border-radius:12px; overflow:hidden;}
        .cmt-head{display:flex; justify-content:space-between; align-items:center; padding:14px 16px; border-bottom:1px solid var(--line); background:#161616;}
        .cmt-title{font-weight:800; font-size:14px;}
        .cmt-info{color:var(--muted); font-size:12px;}

        .cmt-list{padding:6px 0;}
        .cmt-item{display:flex; gap:12px; padding:12px 16px; border-bottom:1px solid var(--line);}
        .cmt-item:last-child{border-bottom:none;}
        .cmt-avatar{width:34px; height:34px; border-radius:50%; background:#2a2a2a; border:1px solid var(--chip-border); display:flex; align-items:center; justify-content:center; font-size:14px; color:#cbd5e1; flex:0 0 34px;}
        .cmt-body{flex:1; min-width:0;}
        .cmt-meta{display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted);}
        .cmt-meta strong{color:#eaeaea; font-weight:700;}
        .cmt-content{margin-top:6px; line-height:1.7; word-break:break-word;}
        .cmt-actions{display:flex; gap:6px; margin-top:8px;}
        .cmt-actions .icon-btn{padding:4px 8px; font-size:12px; color:var(--muted); border:1px solid transparent; background:transparent; border-radius:6px; cursor:pointer;}
        .cmt-actions .icon-btn:hover{background:#1f1f1f; border-color:#2d2d2d; color:#d1d5db;}

        /* 대댓글(스레드) */
        .cmt-thread{margin-top:10px; border-left:2px solid #2a2a2a; padding-left:12px;}
        .cmt-reply{display:flex; gap:10px; padding:10px 0;}
        .cmt-reply .cmt-avatar{width:28px; height:28px; font-size:12px; flex:0 0 28px;}

        /* 작성폼(컴포저) */
        .composer{padding:14px 16px; border-top:1px solid var(--line); background:#141414;}
        .composer-inner{display:flex; gap:10px;}
        .composer .cmt-avatar{margin-top:2px;}
        .composer textarea{flex:1; min-height:46px; max-height:240px; padding:10px 12px; background:#1e1e1e; color:#e5e7eb; border:1px solid #2d2d2d; border-radius:10px; resize:vertical; outline:none;}
        .composer textarea:focus{border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,.15);}
        .composer .composer-actions{display:flex; gap:8px; align-items:flex-end;}
        .composer .btn{height:40px; padding:0 14px; border-radius:10px;}

        /* 소형 버튼 */
        .btn.xs{padding:6px 10px; font-size:12px; border-radius:8px;}

        /* 톤 다운 텍스트 */
        .muted{color:var(--muted);}

        /* toast */
        #toast { position: fixed; left:50%; bottom:40px; transform:translateX(-50%);
            max-width:80vw; padding:12px 16px; border-radius:8px; background:rgba(0,0,0,.8);
            color:#fff; font-size:14px; opacity:0; pointer-events:none;
            transition: opacity .25s ease, transform .25s ease; z-index:9999; }
        #toast.show { opacity:1; transform:translateX(-50%) translateY(-6px); }
    </style>
</head>
<body>
<!-- 네비게이션: 로그인 페이지와 동일하게 header + th:replace -->
<header th:replace="fragments/navbar :: navbar"></header>

<div class="page">

    <!-- 상단: 제목/배지/메타 -->
    <div class="head">
        <div>
            <div class="title" th:text="${post.title}">제목</div>
            <div class="badges">
                <span class="badge notice" th:if="${post.isNotice}">공지</span>
                <span class="badge best" th:if="${post.isBest}">개념</span>
            </div>
        </div>
        <div class="meta">
            <div class="kv"><strong th:text="${post.authorNickname}">작성자</strong></div>
            <div class="divider">|</div>
            <div class="kv" th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd HH:mm:ss')}"></div>
            <div class="divider">|</div>
            <div class="kv">조회 <span th:text="${post.viewCount}">0</span></div>
            <div class="divider">|</div>
            <div class="kv">좋아요 <span th:text="${post.likeCount}">0</span></div>
            <div class="divider">|</div>
            <div class="kv">댓글 <span th:text="${post.commentCount}">0</span></div>
        </div>
    </div>

    <!-- 본문 -->
    <div class="content-wrap">
        <div class="content" th:text="${post.content}"></div>
    </div>

    <!-- 툴바 -->
    <div class="tool-row">
        <a class="btn" th:href="@{|/post/${post.id}/edit|}">수정</a>
        <form th:action="@{|/post/${post.id}/delete|}" method="post" style="display:inline" onsubmit="return confirm('삭제하시겠어요?');">
            <button type="submit" class="btn danger">삭제</button>
        </form>
        <a class="btn ghost" th:if="${isFixedBoard}" th:href="@{|/boards/${slug}|}">목록</a>
        <a class="btn ghost" th:unless="${isFixedBoard}" th:href="@{|/boards/book-discussion/${post.boardId}|}">목록</a>
    </div>

    <!-- flash -->
    <div id="flash-error" th:if="${errorMsg}" th:text="${errorMsg}" hidden></div>
    <div id="flash-toast" th:if="${toast}" th:text="${toast}" hidden></div>

    <!-- 좋아요/싫어요 -->
    <div class="vote-wrap">
        <div class="vote">
            <div class="box">
                <form th:action="@{|/post/${post.id}/like|}" method="post">
                    <button class="btn up" type="submit" title="좋아요">👍</button>
                </form>
                <div class="count" th:text="${post.likeCount}">0</div>
                <div class="label">좋아요</div>
            </div>
            <div class="box">
                <form th:action="@{|/post/${post.id}/dislike|}" method="post">
                    <button class="btn down" type="submit" title="싫어요">👎</button>
                </form>
                <div class="count" th:text="${post.dislikeCount}">0</div>
                <div class="label">싫어요</div>
            </div>
        </div>
    </div>

    <div class="sub-actions">
        <span>📌 스크랩</span>
        <span>🔗 공유</span>
        <span>🚩 신고</span>
    </div>

    <!-- 뉴스 -->
    <div class="news">
        <div class="news-title">실시간 인기 소식</div>
        <ul>
            <li><a href="javascript:void(0)">샘플 뉴스 1</a></li>
            <li><a href="javascript:void(0)">샘플 뉴스 2</a></li>
            <li><a href="javascript:void(0)">샘플 뉴스 3</a></li>
        </ul>
    </div>

    <!-- 댓글 -->
    <div class="cmt-wrap">
        <div class="cmt-head">
            <div class="cmt-title">댓글 <span th:text="${post.commentCount}">0</span></div>
            <div class="cmt-info">※ 운영원칙 위반 댓글은 제재될 수 있습니다.</div>
        </div>

        <!-- 목록 -->
        <div class="cmt-list" th:if="${#lists.size(comments) > 0}">
            <div class="cmt-item" th:each="c : ${comments}">
                <!-- 아바타: 닉네임 첫 글자 -->
                <div class="cmt-avatar" th:text="${#strings.substring(c.authorNickname,0,1)}">A</div>

                <div class="cmt-body">
                    <div class="cmt-meta">
                        <strong th:text="${c.authorNickname}">익명</strong>
                        <span>·</span>
                        <span th:text="${#temporals.format(c.createdAt,'yyyy.MM.dd HH:mm')}">시간</span>

                        <!-- 내 댓글이면 삭제 -->
                        <form th:if="${loginUserId != null and loginUserId == c.userId}"
                              th:action="@{|/comments/${c.id}/delete|}" method="post" style="margin-left:auto">
                            <input type="hidden" name="postId" th:value="${post.id}"/>
                            <button type="submit" class="icon-btn" onclick="return confirm('삭제하시겠어요?')">🗑 삭제</button>
                        </form>
                    </div>

                    <div class="cmt-content" th:classappend="${c.deleted} ? 'muted' : ''"
                         th:text="${c.content}">댓글 내용</div>

                    <div class="cmt-actions">
                        <button class="icon-btn" type="button" th:attr="data-target=${'reply-'+c.id}" onclick="toggleReply(this)">↩ 답글</button>
                        <button class="icon-btn" type="button">🚩 신고</button>
                    </div>

                    <!-- 대댓글 스레드 -->
                    <div class="cmt-thread" th:if="${#lists.size(c.replies) > 0}">
                        <div class="cmt-reply" th:each="r : ${c.replies}">
                            <div class="cmt-avatar" th:text="${#strings.substring(r.authorNickname,0,1)}">A</div>
                            <div class="cmt-body">
                                <div class="cmt-meta">
                                    <strong th:text="${r.authorNickname}">익명</strong>
                                    <span>·</span>
                                    <span th:text="${#temporals.format(r.createdAt,'yyyy.MM.dd HH:mm')}"></span>

                                    <form th:if="${loginUserId != null and loginUserId == r.userId}"
                                          th:action="@{|/comments/${r.id}/delete|}" method="post" style="margin-left:auto">
                                        <input type="hidden" name="postId" th:value="${post.id}"/>
                                        <button type="submit" class="icon-btn" onclick="return confirm('삭제하시겠어요?')">🗑 삭제</button>
                                    </form>
                                </div>
                                <div class="cmt-content" th:text="${r.content}">대댓글 내용</div>
                            </div>
                        </div>
                    </div>

                    <!-- 대댓글 작성폼 (토글) -->
                    <div class="composer" th:id="${'reply-'+c.id}" style="display:none;">
                        <form class="composer-inner" th:action="@{|/post/${post.id}/comments|}" method="post">
                            <div class="cmt-avatar" th:text="${#strings.substring(session.nickname,0,1)}">N</div>
                            <textarea name="content" rows="2" placeholder="답글을 입력하세요" required></textarea>
                            <input type="hidden" name="parentId" th:value="${c.id}"/>
                            <div class="composer-actions">
                                <button type="submit" class="btn xs">등록</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 비어있을 때 -->
        <div class="cmt-list" th:if="${#lists.isEmpty(comments)}">
            <div class="cmt-item">
                <div class="cmt-avatar">🗨</div>
                <div class="cmt-body muted">아직 댓글이 없습니다. 첫 댓글을 남겨보세요.</div>
            </div>
        </div>

        <!-- 루트 댓글 작성(컴포저) -->
        <div class="composer">
            <form class="composer-inner" th:action="@{|/post/${post.id}/comments|}" method="post">
                <div class="cmt-avatar" th:text="${session != null && session.nickname != null ? #strings.substring(session.nickname,0,1) : 'N'}">N</div>
                <textarea name="content" placeholder="댓글을 입력하세요" required></textarea>
                <div class="composer-actions">
                    <button type="submit" class="btn primary">등록</button>
                </div>
            </form>
        </div>
    </div>



</div>

<!-- toast 메시지 -->
<div id="toast" role="status" aria-live="polite"></div>
<script>
    (function () {
        function show(msg){
            var t=document.getElementById('toast');
            t.textContent=msg;
            t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'),2200);
        }
        var e=document.getElementById('flash-error'); if(e) show(e.textContent);
        var s=document.getElementById('flash-toast'); if(s) show(s.textContent);
    })();

    function toggleReply(el){
        var id = el.getAttribute('data-target');
        var box = document.getElementById(id);
        if(!box) return;
        box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
        var ta = box.querySelector('textarea'); if(ta){ ta.focus(); }
    }
    // textarea 자동 리사이즈
    document.addEventListener('input', function(e){
        if(e.target.tagName === 'TEXTAREA'){
            var t=e.target; t.style.height='auto'; t.style.height=(t.scrollHeight)+'px';
        }
    });
</script>

</body>
</html>
